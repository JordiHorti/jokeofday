{"version":3,"file":"categorymanager.min.js","sources":["../src/categorymanager.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Reactive module for category manager\n *\n * @module qbank_managecategories/categorymanager\n */\n\nimport {Reactive} from 'core/reactive';\nimport {get_string as getString} from 'core/str';\nimport {mutations} from 'qbank_managecategories/mutations';\nimport {eventTypes, notifyQbankManagecategoriesStateUpdated} from 'qbank_managecategories/events';\nimport Ajax from \"core/ajax\";\nimport Notification from \"core/notification\";\nimport ModalForm from 'core_form/modalform';\n\nconst SELECTORS = {\n    CATEGORY_LIST: '.qbank_managecategories-categorylist',\n    CONTEXT: '.qbank_managecategories-categorylist[data-contextid]',\n    CATEGORY_ITEM: '.qbank_managecategories-item[data-categoryid]',\n    CATEGORY_ROOT: '#categoryroot',\n    SHOWDESCRIPTIONS_TOGGLE: '#showdescriptions-toggle',\n    ADD_EDIT_BUTTON: '[data-action=\"addeditcategory\"]',\n};\n\nconst CLASSES = {\n    DRAGHANDLE: 'draghandle',\n    DANGER: 'alert-danger',\n};\n\n/**\n * Load the initial state.\n *\n * This iterates over the initial tree of category items, and captures the data required for the state from each category.\n * It also captures a count of the number of children in each list.\n *\n * @param {Reactive} reactive\n * @return {Promise<void>}\n */\nconst loadState = async(reactive) => {\n    const rootElement = document.querySelector(SELECTORS.CATEGORY_ROOT);\n    const stateData = {\n        page: {\n            contextid: rootElement.dataset.contextid,\n            showdescriptions: document.querySelector(SELECTORS.SHOWDESCRIPTIONS_TOGGLE).checked,\n        },\n        categories: [],\n        categoryLists: [],\n    };\n    const listItems = document.querySelectorAll(SELECTORS.CATEGORY_ITEM);\n    listItems.forEach(item => {\n        stateData.categories.push({\n            id: item.dataset.categoryid,\n            name: item.dataset.categoryname,\n            parent: item.dataset.parent,\n            contextid: item.dataset.contextid,\n            sortorder: item.dataset.sortorder,\n            draghandle: item.classList.contains(CLASSES.DRAGHANDLE),\n        });\n    });\n    const categoryLists = document.querySelectorAll(SELECTORS.CATEGORY_LIST);\n    categoryLists.forEach(categoryList => {\n        stateData.categoryLists.push({\n            id: categoryList.dataset.categoryid,\n            childCount: categoryList.querySelectorAll(SELECTORS.CATEGORY_ITEM).length,\n        });\n    });\n    reactive.setInitialState(stateData);\n};\n\n/**\n * Reactive instance for the category manager.\n */\nclass CategoryManager extends Reactive {\n    /**\n     * Move a category to a new position within the given parent.\n     *\n     * This will call the move_category web service function to re-order the categories, then update\n     * the state with the returned updates.\n     *\n     * @param {Number} categoryId The ID of the category being moved.\n     * @param {Number} targetParentId The ID of the destination parent category (this may not have changed).\n     * @param {Number} precedingSiblingId The ID of the category to put the moved category after.\n     *     This may be null if moving to the top of a list.\n     */\n    moveCategory(\n        categoryId,\n        targetParentId,\n        precedingSiblingId = null,\n    ) {\n        const call = {\n            methodname: 'qbank_managecategories_move_category',\n            args: {\n                pagecontextid: this.state.page.contextid,\n                categoryid: categoryId,\n                targetparentid: targetParentId,\n                precedingsiblingid: precedingSiblingId,\n            }\n        };\n        Ajax.call([call])[0]\n            .then((stateUpdates) => {\n                this.stateManager.processUpdates(stateUpdates);\n                return stateUpdates;\n            })\n            .catch(error => {\n                Notification.addNotification({\n                    message: error.message,\n                    type: 'error',\n                });\n                document.getElementsByClassName(CLASSES.DANGER)[0]?.scrollIntoView();\n            });\n    }\n\n    /**\n     * Return title for the add/edit modal.\n     *\n     * @param {boolean} isEdit is 'add' or 'edit' form\n     * @returns {String} title string\n     */\n    getTitle(isEdit) {\n        return getString(isEdit ? 'editcategory' : 'addcategory', 'question');\n    }\n\n    /**\n     * Return save button label for the add/edit modal.\n     *\n     * @param {boolean} isEdit is 'add' or 'edit' form\n     * @returns {String} save string\n     */\n    getSave(isEdit) {\n        return isEdit ? getString('savechanges', 'core') : getString('addcategory', 'question');\n    }\n\n    /**\n     * Function handling display of modal form.\n     *\n     * @param {Event} e The click event triggering the modal.\n     */\n    showEditModal(e) {\n        const addEditButton = e.target.closest(SELECTORS.ADD_EDIT_BUTTON);\n\n        // Return if it is not 'addeditcategory' button.\n        if (!addEditButton) {\n            return;\n        }\n\n        // Return if the action type is not specified.\n        if (!addEditButton.dataset.actiontype) {\n            return;\n        }\n\n        e.preventDefault();\n        // Data for the modal.\n        const title = categorymanager.getTitle(addEditButton.dataset.actiontype === 'edit');\n        const save = categorymanager.getSave(addEditButton.dataset.actiontype === 'edit');\n        const cmid = addEditButton.dataset.cmid;\n        const courseid = addEditButton.dataset.courseid;\n        const questioncount = addEditButton.dataset.questioncount;\n        let contextid = addEditButton.dataset.contextid;\n        let categoryid = null;\n        let sortorder = null;\n        let parent = null;\n        const categoryItem = e.target.closest(SELECTORS.CATEGORY_ITEM);\n        if (categoryItem) {\n            contextid = categoryItem.dataset.contextid;\n            categoryid = categoryItem.dataset.categoryid;\n            sortorder = categoryItem.dataset.sortorder;\n            const parentContext = categoryItem.closest(SELECTORS.CONTEXT);\n            parent = categoryItem.dataset.parent + ',' + parentContext.dataset.contextid;\n        }\n\n        // Call the modal.\n        const modalForm = new ModalForm({\n            formClass: \"qbank_managecategories\\\\form\\\\question_category_edit_form\",\n            args: {\n                cmid,\n                courseid,\n                questioncount,\n                contextid,\n                categoryid,\n                sortorder,\n                parent,\n            },\n            modalConfig: {\n                title: title,\n                large: true,\n            },\n            saveButtonText: save,\n            returnFocus: addEditButton,\n        });\n        // Once the form has been submitted via the web service, update the state with the new or updated\n        // category based on the web service response.\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (response) => {\n            categorymanager.stateManager.processUpdates(response.detail);\n        });\n        // Show the form.\n        modalForm.show();\n    }\n}\n\nexport const categorymanager = new CategoryManager({\n    name: 'qtype_managecategories_categorymanager',\n    eventName: eventTypes.qbankManagecategoriesStateUpdated,\n    eventDispatch: notifyQbankManagecategoriesStateUpdated,\n    mutations,\n});\n\n/**\n * Load the initial state.\n */\nexport const init = () => {\n    loadState(categorymanager);\n};\n"],"names":["_interopRequireDefault","e","__esModule","default","_ajax","_notification","_modalform","SELECTORS","CLASSES","CategoryManager","Reactive","moveCategory","categoryId","targetParentId","precedingSiblingId","arguments","length","undefined","call","methodname","args","pagecontextid","this","state","page","contextid","categoryid","targetparentid","precedingsiblingid","Ajax","then","stateUpdates","stateManager","processUpdates","catch","error","_document$getElements","Notification","addNotification","message","type","document","getElementsByClassName","scrollIntoView","getTitle","isEdit","getString","get_string","getSave","showEditModal","addEditButton","target","closest","dataset","actiontype","preventDefault","title","categorymanager","save","cmid","courseid","questioncount","sortorder","parent","categoryItem","parentContext","modalForm","ModalForm","formClass","modalConfig","large","saveButtonText","returnFocus","addEventListener","events","FORM_SUBMITTED","response","detail","show","name","eventName","eventTypes","qbankManagecategoriesStateUpdated","eventDispatch","notifyQbankManagecategoriesStateUpdated","mutations","_exports","init","async","stateData","querySelector","showdescriptions","checked","categories","categoryLists","querySelectorAll","forEach","item","push","id","categoryname","draghandle","classList","contains","categoryList","childCount","reactive","setInitialState","loadState"],"mappings":"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"}