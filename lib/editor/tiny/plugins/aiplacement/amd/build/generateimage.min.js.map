{"version":3,"file":"generateimage.min.js","sources":["../src/generateimage.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny AI generate images.\n *\n * @module      tiny_aiplacement/generateimage\n * @copyright   2024 Matt Porritt <matt.porritt@moodle.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport ImageModal from 'tiny_aiplacement/imagemodal';\nimport Ajax from 'core/ajax';\nimport {getString} from 'core/str';\nimport Templates from 'core/templates';\nimport AiMediaImage from './mediaimage';\nimport {getContextId} from 'tiny_aiplacement/options';\nimport GenerateBase from 'tiny_aiplacement/generatebase';\n\nexport default class GenerateImage extends GenerateBase {\n    SELECTORS = {\n        GENERATEBUTTON: () => `[id=\"${this.editor.id}_tiny_aiplacement_generatebutton\"]`,\n        PROMPTAREA: () => `[id=\"${this.editor.id}_tiny_aiplacement_imageprompt\"]`,\n        IMAGECONTAINER: () => `[id=\"${this.editor.id}_tiny_aiplacement_generate_image\"]`,\n        GENERATEBTN: '[data-action=\"generate\"]',\n        INSERTBTN: '[data-action=\"inserter\"]',\n        BACKTBTN: '[data-action=\"back\"]',\n        GENERATEDIMAGE: () => `[id=\"${this.editor.id}_tiny_generated_image\"]`,\n    };\n\n    imageURL = null;\n\n    getModalClass() {\n        return ImageModal;\n    }\n\n    /**\n     * Handle click events within the image modal.\n     *\n     * @param {Event} e - The click event object.\n     * @param {HTMLElement} root - The root element of the modal.\n     */\n    handleContentModalClick(e, root) {\n        const actions = {\n            generate: () => this.handleSubmit(root, e.target),\n            inserter: () => this.handleInsert(),\n            cancel: () => this.modalObject.destroy(),\n            back: () => {\n                this.modalObject.destroy();\n                this.displayContentModal();\n            },\n        };\n\n        const actionKey = Object.keys(actions).find(key => e.target.closest(`[data-action=\"${key}\"]`));\n        if (actionKey) {\n            e.preventDefault();\n            actions[actionKey]();\n        }\n    }\n\n    /**\n     * Set up the prompt area in the modal, adding necessary event listeners.\n     *\n     * @param {HTMLElement} root - The root element of the modal.\n     */\n    setupPromptArea(root) {\n        const generateBtn = root.querySelector(this.SELECTORS.GENERATEBUTTON());\n        const promptArea = root.querySelector(this.SELECTORS.PROMPTAREA());\n\n        promptArea.addEventListener('input', () => {\n            generateBtn.disabled = promptArea.value.trim() === '';\n        });\n    }\n\n    /**\n     * Handle the submit action.\n     *\n     * @param {Object} root The root element of the modal.\n     * @param {Object} submitBtn The submit button element.\n     */\n    async handleSubmit(root, submitBtn) {\n        await this.displayLoading(root, submitBtn);\n\n        const displayArgs = this.getDisplayArgs(root);\n        const request = {\n            methodname: 'aiplacement_editor_generate_image',\n            args: displayArgs\n        };\n\n        try {\n            this.responseObj = await Ajax.call([request])[0];\n            if (this.responseObj.error) {\n                this.handleGenerationError(root, submitBtn, '');\n            } else {\n                await this.displayGeneratedImage(root);\n                this.hideLoading(root, submitBtn);\n            }\n        } catch (error) {\n            this.handleGenerationError(root, submitBtn, '');\n        }\n    }\n\n    /**\n     * Handle the insert action.\n     *\n     */\n    async handleInsert() {\n        const mediaImage = new AiMediaImage(this.editor, this.imageURL, this.promptText);\n        await mediaImage.displayDialogue();\n        this.modalObject.destroy();\n    }\n\n    /**\n     * Handle a generation error.\n     *\n     * @param {Object} root The root element of the modal.\n     * @param {Object} submitBtn The submit button element.\n     * @param {String} errorMessage The error message to display.\n     */\n    async handleGenerationError(root, submitBtn, errorMessage = '') {\n        if (!errorMessage) {\n            // Get the default error message.\n            errorMessage = await getString('errorgeneral', 'tiny_aiplacement');\n        }\n        this.hideLoading(root, submitBtn);\n        this.modalObject.setBody(Templates.render('tiny_aiplacement/modalbodyerror', {'errorMessage': errorMessage}));\n        const backBtn = root.querySelector(this.SELECTORS.BACKTBTN);\n        const generateBtn = root.querySelector(this.SELECTORS.GENERATEBUTTON());\n        backBtn.classList.remove('hidden');\n        generateBtn.classList.add('hidden');\n    }\n\n    /**\n     * Display the generated image in the modal.\n     *\n     * @param {HTMLElement} root - The root element of the modal.\n     */\n    async displayGeneratedImage(root) {\n        const imageDisplayContainer = root.querySelector(this.SELECTORS.IMAGECONTAINER());\n        const insertBtn = root.querySelector(this.SELECTORS.INSERTBTN);\n        // Set the draft URL as it's used elsewhere.\n        this.imageURL = this.responseObj.drafturl;\n\n        // Render the image template and insert it into the modal.\n        imageDisplayContainer.innerHTML = await Templates.render('tiny_aiplacement/image', {\n            url: this.responseObj.drafturl,\n            elementid: this.editor.id,\n            alt: this.promptText,\n        });\n        const imagElement = root.querySelector(this.SELECTORS.GENERATEDIMAGE());\n\n        return new Promise((resolve, reject) => {\n            imagElement.onload = () => {\n                insertBtn.classList.remove('hidden');\n                resolve(); // Resolve the promise when the image is loaded.\n            };\n            imagElement.onerror = (error) => {\n                reject(error); // Reject the promise if there is an error loading the image.\n            };\n        });\n    }\n\n    /**\n     * Get the display args for the image.\n     *\n     * @param {Object} root The root element of the modal.\n     */\n    getDisplayArgs(root) {\n        const contextId = getContextId(this.editor);\n        const promptText = root.querySelector(this.SELECTORS.PROMPTAREA()).value;\n        this.promptText = promptText;\n\n        const aspectRatio = this.getSelectedRadioValue('aspect-ratio', 'square');\n        const imageQuality = this.getSelectedRadioValue('quality', 'standard');\n\n        return {\n            contextid: contextId,\n            prompttext: promptText,\n            aspectratio: aspectRatio,\n            quality: imageQuality ? 'hd' : 'standard',\n            numimages: 1\n        };\n    }\n\n    /**\n     * Get the value of the selected radio button.\n     *\n     * @param {String} radioName The name of the radio button group.\n     * @param {String} defaultValue The default value of the radio button.\n     */\n    getSelectedRadioValue(radioName, defaultValue = null) {\n        const radios = document.getElementsByName(radioName);\n        for (const radio of radios) {\n            if (radio.checked) {\n                return radio.value;\n            }\n        }\n        return defaultValue;\n    }\n}\n"],"names":["_interopRequireDefault","e","__esModule","default","_imagemodal","_ajax","_templates","_mediaimage","_generatebase","GenerateImage","GenerateBase","SELECTORS","GENERATEBUTTON","this","editor","id","PROMPTAREA","IMAGECONTAINER","GENERATEBTN","INSERTBTN","BACKTBTN","GENERATEDIMAGE","imageURL","getModalClass","ImageModal","handleContentModalClick","root","actions","generate","handleSubmit","target","inserter","handleInsert","cancel","modalObject","destroy","back","displayContentModal","actionKey","Object","keys","find","key","closest","preventDefault","setupPromptArea","generateBtn","querySelector","promptArea","addEventListener","disabled","value","trim","submitBtn","displayLoading","request","methodname","args","getDisplayArgs","responseObj","Ajax","call","error","handleGenerationError","displayGeneratedImage","hideLoading","mediaImage","AiMediaImage","promptText","displayDialogue","errorMessage","arguments","length","undefined","getString","setBody","Templates","render","backBtn","classList","remove","add","imageDisplayContainer","insertBtn","drafturl","innerHTML","url","elementid","alt","imagElement","Promise","resolve","reject","onload","onerror","contextId","getContextId","contextid","prompttext","aspectratio","getSelectedRadioValue","quality","numimages","radioName","defaultValue","radios","document","getElementsByName","radio","checked","_exports"],"mappings":"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"}